name: E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/e2e/**'
      - 'frontend/src/**'
      - 'backend/src/**'
      - '.github/workflows/e2e-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/e2e/**'
      - 'frontend/src/**'
      - 'backend/src/**'
      - '.github/workflows/e2e-ci.yml'
  workflow_dispatch:

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      # Database configuration
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: test_db
      
      # Backend configuration
      NODE_ENV: test
      PORT: 4000
      JWT_SECRET: test_secret_for_ci_only_minimum_32_characters
      ENCRYPTION_KEY: test-encryption-key-minimum-32-characters-long-for-testing
      
      # Frontend configuration
      NEXT_PUBLIC_API_URL: http://localhost:4000/api
      NEXT_TELEMETRY_DISABLED: 1
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'yarn'
          cache-dependency-path: |
            backend/yarn.lock
            frontend/yarn.lock

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U test_user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

      - name: Setup database
        env:
          PGPASSWORD: test_password
        run: |
          # Enable UUID extension
          echo "Enabling UUID extension..."
          psql -h localhost -U test_user -d test_db -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";" || exit 1
          
          # Run all SQL migrations in order
          echo "Running database migrations..."
          MIGRATION_COUNT=0
          for migration in $(ls database/migrations/*.sql 2>/dev/null | sort); do
            echo "Running migration: $(basename $migration)"
            OUTPUT=$(psql -h localhost -U test_user -d test_db -f "$migration" -v ON_ERROR_STOP=1 2>&1)
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "✓ Migration $(basename $migration) completed"
              MIGRATION_COUNT=$((MIGRATION_COUNT + 1))
            else
              echo "$OUTPUT"
              echo "✗ Migration $(basename $migration) failed"
              exit 1
            fi
          done
          echo "Successfully ran $MIGRATION_COUNT migrations"
          
          # Verify key tables exist
          TABLE_COUNT=$(psql -h localhost -U test_user -d test_db -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('companies', 'users', 'customers', 'tickets', 'invoices');")
          if [ "$TABLE_COUNT" -lt 5 ]; then
            echo "ERROR: Not all required tables exist!"
            exit 1
          fi
          echo "✓ Database schema verified"

      - name: Install backend dependencies
        working-directory: ./backend
        run: yarn install --frozen-lockfile

      - name: Build backend
        working-directory: ./backend
        run: yarn build

      - name: Start backend server
        working-directory: ./backend
        run: |
          yarn start &
          echo $! > backend.pid
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: test_user
          DB_PASSWORD: test_password
          DB_NAME: test_db
          NODE_ENV: test
          PORT: 4000
          JWT_SECRET: test_secret_for_ci_only_minimum_32_characters
          ENCRYPTION_KEY: test-encryption-key-minimum-32-characters-long-for-testing

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend API to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:4000/health > /dev/null 2>&1; then
              echo "Backend is ready!"
              exit 0
            fi
            echo "Attempt $i: Backend not ready yet, waiting..."
            sleep 2
          done
          echo "Backend failed to start"
          exit 1

      - name: Create test users
        run: |
          echo "Creating test users for E2E tests..."
          # Wait a bit more to ensure backend is fully ready
          sleep 5
          
          # Create test users via registration API
          # These match the TEST_USERS in frontend/e2e/helpers/auth.ts
          create_user() {
            local email=$1
            local password=$2
            local firstName=$3
            local lastName=$4
            local companyName=$5
            
            echo "Creating user: $email"
            response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:4000/api/auth/register \
              -H "Content-Type: application/json" \
              -d "{
                \"email\": \"$email\",
                \"password\": \"$password\",
                \"firstName\": \"$firstName\",
                \"lastName\": \"$lastName\",
                \"companyName\": \"$companyName\"
              }")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "✓ Created user: $email"
            elif echo "$body" | grep -q "already exists\|duplicate"; then
              echo "⚠ User $email already exists (skipping)"
            else
              echo "✗ Failed to create user $email (HTTP $http_code)"
              echo "Response: $body"
              # Don't fail - user might already exist
            fi
          }
          
          # Create test company and users
          # First user creates the company
          create_user "admin@test.com" "testpassword123" "Admin" "User" "E2E Test Company"
          create_user "manager@test.com" "testpassword123" "Manager" "User" "E2E Test Company"
          create_user "technician@test.com" "testpassword123" "Technician" "User" "E2E Test Company"
          create_user "frontdesk@test.com" "testpassword123" "Frontdesk" "User" "E2E Test Company"
          
          echo "Test users setup complete"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: ./frontend
        run: yarn build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000/api

      - name: Start frontend server
        working-directory: ./frontend
        run: |
          yarn start &
          echo $! > frontend.pid
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: http://localhost:4000/api
          PORT: 3000

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "Frontend is ready!"
              exit 0
            fi
            echo "Attempt $i: Frontend not ready yet, waiting..."
            sleep 2
          done
          echo "Frontend failed to start"
          exit 1

      - name: Run E2E tests
        working-directory: ./frontend
        run: yarn test:e2e
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000/api
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:3000

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: frontend/test-results/
          retention-days: 7

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: frontend/test-results/
          retention-days: 7

      - name: Stop backend server
        if: always()
        run: |
          if [ -f backend/backend.pid ]; then
            kill $(cat backend/backend.pid) || true
            rm backend/backend.pid || true
          fi

      - name: Stop frontend server
        if: always()
        run: |
          if [ -f frontend/frontend.pid ]; then
            kill $(cat frontend/frontend.pid) || true
            rm frontend/frontend.pid || true
          fi

